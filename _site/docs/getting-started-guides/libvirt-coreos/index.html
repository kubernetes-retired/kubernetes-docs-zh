

<!Doctype html>
<html id="docs">


<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" type="image/png" href="/images/favicon.png">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Roboto+Mono' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/jquery-2.2.0.min.js"></script>
	<script src="/js/script.js"></script>
	<title>Kubernetes - libvirt on CoreOS</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs/" class="button" id="viewDocs">View Documentation</a>
		<a href="/docs/hellonode/" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="/docs/hellonode/">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="/docs/">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="/community/">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="http://blog.kubernetes.io">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
					<a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>


<!--  HERO  -->
<section id="hero" class="light-text">
	<h1>Guides</h1>
	<h5>How to get started, and acheive tasks, using Kubernetes</h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/docs/">GUIDES</a></li>
			<li><a href="/docs/reference">REFERENCE</a></li>
			<li><a href="/docs/samples">SAMPLES</a></li>
			<li><a href="/docs/troubleshooting/">SUPPORT</a></li>
		</ul><!--
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1/">Version 1.1</a>
            <a href="/v1.2/">Version 1.2</a>
		</div>-->
		<input type="text" id="search" placeholder="Search" onkeydown="if (event.keyCode==13) window.location.replace('/docs/search/?q=' + this.value)">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
        
    <a class="item" data-title="Guides" href="/docs/"></a>
<div class="item" data-title="Getting Started">
  <div class="container">
    <a class="item" data-title="What is Kubernetes?" href="/docs/whatisk8s/"></a>
    <a class="item" data-title="Downloading Kubernetes" href="/docs/getting-started-guides/binary_release/"></a>
    <a class="item" data-title="Hello World Walkthrough" href="/docs/hellonode/"></a>
    <a class="item" data-title="Kubernetes 101" href="/docs/user-guide/walkthrough/"></a>
    <a class="item" data-title="Kubernetes 201" href="/docs/user-guide/walkthrough/k8s201/"></a>
  </div>
</div>
    <a class="item" data-title="User Guide" href="/docs/user-guide/"></a>
    <a class="item" data-title="Admin Guide" href="/docs/admin/"></a>
<div class="item" data-title="Running Kubernetes">
  <div class="container">
    <a class="item" data-title="Picking the Right Solution" href="/docs/getting-started-guides/"></a>
<div class="item" data-title="Running Kubernetes on Your Local Machine">
  <div class="container">
    <a class="item" data-title="Running Kubernetes Locally via Docker" href="/docs/getting-started-guides/docker/"></a>
    <a class="item" data-title="Running Kubernetes Locally via Vagrant" href="/docs/getting-started-guides/vagrant/"></a>
    <a class="item" data-title="Running Kubernetes Locally with No VM" href="/docs/getting-started-guides/locally/"></a>
  </div>
</div>
<div class="item" data-title="Running Kubernetes on Turn-key Cloud Solutions">
  <div class="container">
    <a class="item" data-title="Running Kubernetes on Google Container Engine" href="https://cloud.google.com/container-engine/docs/before-you-begin/" target='_blank'></a>
    <a class="item" data-title="Running Kubernetes on Google Compute Engine" href="/docs/getting-started-guides/gce/"></a>
    <a class="item" data-title="Running Kubernetes on AWS EC2" href="/docs/getting-started-guides/aws/"></a>
    <a class="item" data-title="Running Kubernetes on Azure" href="/docs/getting-started-guides/coreos/azure/"></a>
  </div>
</div>
<div class="item" data-title="Running Kubernetes on Custom Solutions">
  <div class="container">
    <a class="item" data-title="Getting Started From Scratch" href="/docs/getting-started-guides/scratch/"></a>
<div class="item" data-title="Custom Cloud Solutions">
  <div class="container">
    <a class="item" data-title="AWS or GCE on CoreOS" href="/docs/getting-started-guides/coreos/"></a>
    <a class="item" data-title="AWS or Joyent on Ubuntu" href="/docs/getting-started-guides/juju/"></a>
    <a class="item" data-title="Rackspace on CoreOS" href="/docs/getting-started-guides/rackspace/"></a>
  </div>
</div>
<div class="item" data-title="On-Premise VMs">
  <div class="container">
    <a class="item" data-title="Vagrant or VMware" href="/docs/getting-started-guides/coreos/"></a>
    <a class="item" data-title="Cloudstack" href="/docs/getting-started-guides/cloudstack/"></a>
    <a class="item" data-title="VMWare" href="/docs/getting-started-guides/vsphere/"></a>
    <a class="item" data-title="Juju" href="/docs/getting-started-guides/juju/"></a>
    <a class="item" data-title="DCOS" href="/docs/getting-started-guides/dcos/"></a>
    <a class="item" data-title="libvirt on CoreOS" href="/docs/getting-started-guides/libvirt-coreos/"></a>
    <a class="item" data-title="oVirt" href="/docs/getting-started-guides/ovirt/"></a>
    <a class="item" data-title="libvirt or KVM" href="/docs/getting-started-guides/fedora/flannel_multi_node_cluster/"></a>
    <a class="item" data-title="Multinode Cluster on CoreOS" href="/docs/getting-started-guides/coreos/coreos_multinode_cluster/"></a>
    <a class="item" data-title="Fedora With Calico Networking" href="/docs/getting-started-guides/fedora/fedora-calico/"></a>
    <a class="item" data-title="rkt" href="/docs/getting-started-guides/rkt/"></a>
    <a class="item" data-title="Kubernetes on Mesos" href="/docs/getting-started-guides/mesos/"></a>
    <a class="item" data-title="Kubernetes on Mesos on Docker" href="/docs/getting-started-guides/mesos-docker/"></a>
  </div>
</div>
<div class="item" data-title="Bare Metal">
  <div class="container">
    <a class="item" data-title="Offline" href="/docs/getting-started-guides/coreos/bare_metal_offline/"></a>
    <a class="item" data-title="Fedora via Ansible" href="/docs/getting-started-guides/fedora/fedora_ansible_config/"></a>
    <a class="item" data-title="Fedora (Single Node)" href="/docs/getting-started-guides/fedora/fedora_manual_config/"></a>
    <a class="item" data-title="Fedora (Multi Node)" href="/docs/getting-started-guides/fedora/flannel_multi_node_cluster/"></a>
    <a class="item" data-title="Centos" href="/docs/getting-started-guides/centos/centos_manual_config/"></a>
    <a class="item" data-title="Ubuntu" href="/docs/getting-started-guides/ubuntu/"></a>
    <a class="item" data-title="Docker (Multi-Node)" href="/docs/getting-started-guides/docker-multinode/"></a>
    <a class="item" data-title="CoreOS with Calico" href="/docs/getting-started-guides/coreos/bare_metal_calico/"></a>
    <a class="item" data-title="Ubuntu Nodes with Calico" href="/docs/getting-started-guides/ubuntu-calico/"></a>
  </div>
</div>
  </div>
</div>
  </div>
</div>
<div class="item" data-title="Administering Clusters">
  <div class="container">
    <a class="item" data-title="Cluster Management Guide" href="/docs/admin/cluster-management/"></a>
    <a class="item" data-title="Anatomy of a Cluster" href="/docs/admin/cluster-components/"></a>
    <a class="item" data-title="Using Multiple Clusters" href="/docs/admin/multi-cluster/"></a>
    <a class="item" data-title="Using Large Clusters" href="/docs/admin/cluster-large/"></a>
    <a class="item" data-title="Building High-Availability Clusters" href="/docs/admin/high-availability/"></a>
    <a class="item" data-title="Accessing Clusters" href="/docs/user-guide/accessing-the-cluster/"></a>
    <a class="item" data-title="Sharing a Cluster" href="/docs/admin/namespaces/"></a>
    <a class="item" data-title="Changing Cluster Size" href="https://github.com/kubernetes/kubernetes/wiki/User-FAQ#how-do-i-change-the-size-of-my-cluster/" target='_blank'></a>
    <a class="item" data-title="Creating a Custom Cluster from Scratch" href="/docs/getting-started-guides/scratch/"></a>
    <a class="item" data-title="Authenticating Across Clusters with kubeconfig" href="/docs/user-guide/kubeconfig-file/"></a>
  </div>
</div>
<div class="item" data-title="Using Nodes, Pods, and Containers">
  <div class="container">
    <a class="item" data-title="The Container Environment" href="/docs/user-guide/container-environment/"></a>
    <a class="item" data-title="Running Your First Containers" href="/docs/user-guide/simple-nginx/"></a>
    <a class="item" data-title="Working with Containers" href="/docs/user-guide/production-pods/"></a>
    <a class="item" data-title="Overriding Default Container Behavior" href="/docs/user-guide/containers/"></a>
    <a class="item" data-title="Running Commands in a Container with kubectl exec" href="/docs/user-guide/getting-into-containers/"></a>
    <a class="item" data-title="The Lifecycle of a Pod" href="/docs/user-guide/pod-states/"></a>
    <a class="item" data-title="Assigning Pods to Nodes" href="/docs/user-guide/node-selection/"></a>
    <a class="item" data-title="Creating Pods with the Downward API" href="/docs/user-guide/downward-api/"></a>
    <a class="item" data-title="Updating Live Pods" href="/docs/user-guide/update-demo/"></a>
    <a class="item" data-title="Installing a Kubernetes Master Node via Docker" href="/docs/getting-started-guides/docker-multinode/master/"></a>
    <a class="item" data-title="Adding a Kubernetes Worker Node via Docker" href="/docs/getting-started-guides/docker-multinode/worker/"></a>
  </div>
</div>
<div class="item" data-title="Networking">
  <div class="container">
    <a class="item" data-title="Networking in Kubernetes" href="/docs/admin/networking/"></a>
    <a class="item" data-title="Using DNS Pods and Services" href="/docs/admin/dns/"></a>
    <a class="item" data-title="Setting Up and Configuring DNS" href="https://github.com/kubernetes/kubernetes/tree/release-1.1/examples/cluster-dns" target='_blank'></a>
    <a class="item" data-title="Deploying DNS" href="/docs/getting-started-guides/docker-multinode/deployDNS/"></a>
    <a class="item" data-title="Connecting Applications" href="/docs/user-guide/connecting-applications/"></a>
    <a class="item" data-title="Creating Servers with External IPs" href="https://github.com/kubernetes/kubernetes/blob/release-1.1/examples/simple-nginx.md" target='_blank'></a>
    <a class="item" data-title="Connect with Proxies" href="/docs/user-guide/connecting-to-applications-proxy/"></a>
    <a class="item" data-title="Connect with Port Forwarding" href="/docs/user-guide/connecting-to-applications-port-forward/"></a>
    <a class="item" data-title="Configuring Your Cloud Provider's Firewalls" href="/docs/user-guide/services-firewalls/"></a>
  </div>
</div>
<div class="item" data-title="Configuring Kubernetes">
  <div class="container">
    <a class="item" data-title="Using Configuration Files" href="/docs/user-guide/simple-yaml/"></a>
    <a class="item" data-title="Best Practices for Configuration" href="/docs/user-guide/config-best-practices/"></a>
    <a class="item" data-title="Configuring Containers" href="/docs/user-guide/configuring-containers/"></a>
    <a class="item" data-title="Sharing Cluster Access with kubeconfig" href="/docs/user-guide/sharing-clusters/"></a>
    <a class="item" data-title="Using Environment Variables" href="/docs/user-guide/environment-guide/"></a>
    <a class="item" data-title="Managing Compute Resources" href="/docs/user-guide/compute-resources/"></a>
    <a class="item" data-title="Using kubectl to Manage Resources" href="/docs/user-guide/working-with-resources/"></a>
    <a class="item" data-title="Applying Resource Quotas and Limits" href="/docs/admin/resourcequota/"></a>
    <a class="item" data-title="Setting Pod CPU and Memory Limits" href="/docs/admin/limitrange/"></a>
    <a class="item" data-title="Configuring Garbage Collection" href="/docs/admin/garbage-collection/"></a>
    <a class="item" data-title="Configuring Kubernetes with Salt" href="/docs/admin/salt/"></a>
    <a class="item" data-title="Configuring Kubernetes Use of etcd" href="/docs/admin/etcd/"></a>
  </div>
</div>
<div class="item" data-title="Application Management and Deployment">
  <div class="container">
    <a class="item" data-title="Managing Applications: Prerequisites" href="/docs/user-guide/prereqs/"></a>
    <a class="item" data-title="Managing Deployments" href="/docs/user-guide/managing-deployments/"></a>
    <a class="item" data-title="Deploying Applications" href="/docs/user-guide/deploying-applications/"></a>
    <a class="item" data-title="Launching, Exposing, and Killing Applications" href="/docs/user-guide/quick-start/"></a>
  </div>
</div>
<div class="item" data-title="Testing and Monitoring">
  <div class="container">
    <a class="item" data-title="Testing a Kubernetes Cluster" href="/docs/getting-started-guides/docker-multinode/testing/"></a>
    <a class="item" data-title="Simulating Large Test Loads" href="https://github.com/kubernetes/kubernetes/tree/release-1.1/examples/k8petstore" target='_blank'></a>
    <a class="item" data-title="Checking Pod Health" href="/docs/user-guide/liveness/"></a>
    <a class="item" data-title="Using Explorer to Examine the Runtime Environment" href="https://github.com/kubernetes/kubernetes/tree/release-1.1/examples/explorer" target='_blank'></a>
    <a class="item" data-title="Resource Usage Monitoring" href="/docs/user-guide/monitoring/"></a>
    <a class="item" data-title="Logging" href="/docs/getting-started-guides/logging/"></a>
    <a class="item" data-title="Logging with Elasticsearch and Kibana" href="/docs/getting-started-guides/logging-elasticsearch/"></a>
  </div>
</div>
        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
        <p><a href="/docs/editdocs#docs/getting-started-guides/libvirt-coreos.md" id="editPageButton">Edit This Page</a></p>
    	<h1>libvirt on CoreOS</h1>
		<ul id="markdown-toc">
  <li><a href="#highlights" id="markdown-toc-highlights">Highlights</a></li>
  <li><a href="#warnings-about-libvirt-coreos-use-case" id="markdown-toc-warnings-about-libvirt-coreos-use-case">Warnings about <code class="highlighter-rouge">libvirt-coreos</code> use case</a></li>
  <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a>    <ul>
      <li><a href="#sup1-depending-on-your-distribution-libvirt-access-may-be-denied-by-default-or-may-require-a-password-at-each-access" id="markdown-toc-sup1-depending-on-your-distribution-libvirt-access-may-be-denied-by-default-or-may-require-a-password-at-each-access">¹ Depending on your distribution, libvirt access may be denied by default or may require a password at each access.</a></li>
      <li><a href="#sup2-qemu-will-run-with-a-specific-user-it-must-have-access-to-the-vms-drives" id="markdown-toc-sup2-qemu-will-run-with-a-specific-user-it-must-have-access-to-the-vms-drives">² Qemu will run with a specific user. It must have access to the VMs drives</a></li>
    </ul>
  </li>
  <li><a href="#setup" id="markdown-toc-setup">Setup</a></li>
  <li><a href="#interacting-with-your-kubernetes-cluster-with-the-kube--scripts" id="markdown-toc-interacting-with-your-kubernetes-cluster-with-the-kube--scripts">Interacting with your Kubernetes cluster with the <code class="highlighter-rouge">kube-*</code> scripts.</a></li>
  <li><a href="#troubleshooting" id="markdown-toc-troubleshooting">Troubleshooting</a>    <ul>
      <li><a href="#cannot-find-kubernetes-server-linux-amd64targz" id="markdown-toc-cannot-find-kubernetes-server-linux-amd64targz">!!! Cannot find kubernetes-server-linux-amd64.tar.gz</a></li>
      <li><a href="#cant-find-virsh-in-path-please-fix-and-retry" id="markdown-toc-cant-find-virsh-in-path-please-fix-and-retry">Can’t find virsh in PATH, please fix and retry.</a></li>
      <li><a href="#error-failed-to-connect-socket-to-varrunlibvirtlibvirt-sock-no-such-file-or-directory" id="markdown-toc-error-failed-to-connect-socket-to-varrunlibvirtlibvirt-sock-no-such-file-or-directory">error: Failed to connect socket to ‘/var/run/libvirt/libvirt-sock’: No such file or directory</a></li>
      <li><a href="#error-failed-to-connect-socket-to-varrunlibvirtlibvirt-sock-permission-denied" id="markdown-toc-error-failed-to-connect-socket-to-varrunlibvirtlibvirt-sock-permission-denied">error: Failed to connect socket to ‘/var/run/libvirt/libvirt-sock’: Permission denied</a></li>
      <li><a href="#error-out-of-memory-initializing-network-virsh-net-create" id="markdown-toc-error-out-of-memory-initializing-network-virsh-net-create">error: Out of memory initializing network (virsh net-create…)</a></li>
    </ul>
  </li>
</ul>

<h3 id="highlights">Highlights</h3>

<ul>
  <li>Super-fast cluster boot-up (few seconds instead of several minutes for vagrant)</li>
  <li>Reduced disk usage thanks to <a href="https://en.wikibooks.org/wiki/QEMU/Images#Copy_on_write">COW</a></li>
  <li>Reduced memory footprint thanks to <a href="https://www.kernel.org/doc/Documentation/vm/ksm.txt">KSM</a></li>
</ul>

<h3 id="warnings-about-libvirt-coreos-use-case">Warnings about <code class="highlighter-rouge">libvirt-coreos</code> use case</h3>

<p>The primary goal of the <code class="highlighter-rouge">libvirt-coreos</code> cluster provider is to deploy a multi-node Kubernetes cluster on local VMs as fast as possible and to be as light as possible in term of resources used.</p>

<p>In order to achieve that goal, its deployment is very different from the ‘standard production deployment’? method used on other providers. This was done on purpose in order to implement some optimizations made possible by the fact that we know that all VMs will be running on the same physical machine.</p>

<p>The <code class="highlighter-rouge">libvirt-coreos</code> cluster provider doesn’t aim at being production look-alike.</p>

<p>Another difference is that no security is enforced on <code class="highlighter-rouge">libvirt-coreos</code> at all. For example,</p>

<ul>
  <li>Kube API server is reachable via a clear-text connection (no SSL);</li>
  <li>Kube API server requires no credentials;</li>
  <li>etcd access is not protected;</li>
  <li>Kubernetes secrets are not protected as securely as they are on production environments;</li>
  <li>etc.</li>
</ul>

<p>So, an k8s application developer should not validate its interaction with Kubernetes on <code class="highlighter-rouge">libvirt-coreos</code> because he might technically succeed in doing things that are prohibited on a production environment like:</p>

<ul>
  <li>un-authenticated access to Kube API server;</li>
  <li>Access to Kubernetes private data structures inside etcd;</li>
  <li>etc.</li>
</ul>

<p>On the other hand, <code class="highlighter-rouge">libvirt-coreos</code> might be useful for people investigating low level implementation of Kubernetes because debugging techniques like sniffing the network traffic or introspecting the etcd content are easier on <code class="highlighter-rouge">libvirt-coreos</code> than on a production deployment.</p>

<h3 id="prerequisites">Prerequisites</h3>

<ol>
  <li>Install <a href="http://www.thekelleys.org.uk/dnsmasq/doc">dnsmasq</a></li>
  <li>Install <a href="http://ebtables.netfilter.org/">ebtables</a></li>
  <li>Install <a href="http://wiki.qemu.org/Main_Page">qemu</a></li>
  <li>Install <a href="http://libvirt.org/">libvirt</a></li>
  <li>Enable and start the libvirt daemon, e.g:
    <ul>
      <li><code class="highlighter-rouge">systemctl enable libvirtd</code></li>
      <li><code class="highlighter-rouge">systemctl start libvirtd</code></li>
    </ul>
  </li>
  <li><a href="https://libvirt.org/aclpolkit">Grant libvirt access to your user¹</a></li>
  <li>Check that your $HOME is accessible to the qemu user²</li>
</ol>

<h4 id="sup1-depending-on-your-distribution-libvirt-access-may-be-denied-by-default-or-may-require-a-password-at-each-access">¹ Depending on your distribution, libvirt access may be denied by default or may require a password at each access.</h4>

<p>You can test it with the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>virsh -c qemu:///system pool-list
</code></pre>
</div>

<p>If you have access error messages, please read https://libvirt.org/acl.html and https://libvirt.org/aclpolkit.html .</p>

<p>In short, if your libvirt has been compiled with Polkit support (ex: Arch, Fedora 21), you can create <code class="highlighter-rouge">/etc/polkit-1/rules.d/50-org.libvirt.unix.manage.rules</code> as follows to grant full access to libvirt to <code class="highlighter-rouge">$USER</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo /bin/sh -c <span class="s2">"cat - &gt; /etc/polkit-1/rules.d/50-org.libvirt.unix.manage.rules"</span> <span class="sh">&lt;&lt; EOF
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">polkit</span>.<span class="n">addRule</span>(<span class="n">function</span>(<span class="n">action</span>, <span class="n">subject</span>) {
        <span class="n">if</span> (<span class="n">action</span>.<span class="n">id</span> == <span class="s2">"org.libvirt.unix.manage"</span> &amp;&amp;
            <span class="n">subject</span>.<span class="n">user</span> == <span class="s2">"$USER"</span>) {
                <span class="n">return</span> <span class="n">polkit</span>.<span class="n">Result</span>.<span class="n">YES</span>;
                <span class="n">polkit</span>.<span class="n">log</span>(<span class="s2">"action="</span> + <span class="n">action</span>);
                <span class="n">polkit</span>.<span class="n">log</span>(<span class="s2">"subject="</span> + <span class="n">subject</span>);
        }
});
<span class="n">EOF</span>
</code></pre>
</div>

<p>If your libvirt has not been compiled with Polkit (ex: Ubuntu 14.04.1 LTS), check the permissions on the libvirt unix socket:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ls -l /var/run/libvirt/libvirt-sock
srwxrwx--- 1 root libvirtd 0 févr. 12 16:03 /var/run/libvirt/libvirt-sock

<span class="gp">$ </span>usermod -a -G libvirtd <span class="nv">$USER</span>
<span class="c"># $USER needs to logout/login to have the new group be taken into account</span>
</code></pre>
</div>

<p>(Replace <code class="highlighter-rouge">$USER</code> with your login name)</p>

<h4 id="sup2-qemu-will-run-with-a-specific-user-it-must-have-access-to-the-vms-drives">² Qemu will run with a specific user. It must have access to the VMs drives</h4>

<p>All the disk drive resources needed by the VM (CoreOS disk image, Kubernetes binaries, cloud-init files, etc.) are put inside <code class="highlighter-rouge">./cluster/libvirt-coreos/libvirt_storage_pool</code>.</p>

<p>As we’re using the <code class="highlighter-rouge">qemu:///system</code> instance of libvirt, qemu will run with a specific <code class="highlighter-rouge">user:group</code> distinct from your user. It is configured in <code class="highlighter-rouge">/etc/libvirt/qemu.conf</code>. That qemu user must have access to that libvirt storage pool.</p>

<p>If your <code class="highlighter-rouge">$HOME</code> is world readable, everything is fine. If your $HOME is private, <code class="highlighter-rouge">cluster/kube-up.sh</code> will fail with an error message like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>error: Cannot access storage file <span class="s1">'$HOME/.../kubernetes/cluster/libvirt-coreos/libvirt_storage_pool/kubernetes_master.img'</span> <span class="o">(</span>as uid:99, gid:78<span class="o">)</span>: Permission denied
</code></pre>
</div>

<p>In order to fix that issue, you have several possibilities:</p>

<ul>
  <li>set <code class="highlighter-rouge">POOL_PATH</code> inside <code class="highlighter-rouge">cluster/libvirt-coreos/config-default.sh</code> to a directory:
    <ul>
      <li>backed by a filesystem with a lot of free disk space</li>
      <li>writable by your user;</li>
      <li>accessible by the qemu user.</li>
    </ul>
  </li>
  <li>Grant the qemu user access to the storage pool.</li>
</ul>

<p>On Arch:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>setfacl -m g:kvm:--x ~
</code></pre>
</div>

<h3 id="setup">Setup</h3>

<p>By default, the libvirt-coreos setup will create a single Kubernetes master and 3 Kubernetes nodes. Because the VM drives use Copy-on-Write and because of memory ballooning and KSM, there is a lot of resource over-allocation.</p>

<p>To start your local cluster, open a shell and run:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>kubernetes

<span class="nb">export </span><span class="nv">KUBERNETES_PROVIDER</span><span class="o">=</span>libvirt-coreos
cluster/kube-up.sh
</code></pre>
</div>

<p>The <code class="highlighter-rouge">KUBERNETES_PROVIDER</code> environment variable tells all of the various cluster management scripts which variant to use.  If you forget to set this, the assumption is you are running on Google Compute Engine.</p>

<p>The <code class="highlighter-rouge">NUM_MINIONS</code> environment variable may be set to specify the number of nodes to start. If it is not set, the number of nodes defaults to 3.</p>

<p>The <code class="highlighter-rouge">KUBE_PUSH</code> environment variable may be set to specify which Kubernetes binaries must be deployed on the cluster. Its possible values are:</p>

<ul>
  <li><code class="highlighter-rouge">release</code> (default if <code class="highlighter-rouge">KUBE_PUSH</code> is not set) will deploy the binaries of <code class="highlighter-rouge">_output/release-tars/kubernetes-server-'|.tar.gz</code>. This is built with <code class="highlighter-rouge">make release</code> or <code class="highlighter-rouge">make release-skip-tests</code>.</li>
  <li><code class="highlighter-rouge">local</code> will deploy the binaries of <code class="highlighter-rouge">_output/local/go/bin</code>. These are built with <code class="highlighter-rouge">make</code>.</li>
</ul>

<p>You can check that your machines are there and running with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>virsh -c qemu:///system list
 Id    Name                           State
----------------------------------------------------
 15    kubernetes_master              running
 16    kubernetes_minion-01           running
 17    kubernetes_minion-02           running
 18    kubernetes_minion-03           running
</code></pre>
</div>

<p>You can check that the Kubernetes cluster is working with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl get nodes
NAME                LABELS              STATUS
192.168.10.2        &lt;none&gt;              Ready
192.168.10.3        &lt;none&gt;              Ready
192.168.10.4        &lt;none&gt;              Ready
</code></pre>
</div>

<p>The VMs are running <a href="https://coreos.com/">CoreOS</a>.
Your ssh keys have already been pushed to the VM. (It looks for ~/.ssh/id_*.pub)
The user to use to connect to the VM is <code class="highlighter-rouge">core</code>.
The IP to connect to the master is 192.168.10.1.
The IPs to connect to the nodes are 192.168.10.2 and onwards.</p>

<p>Connect to <code class="highlighter-rouge">kubernetes_master</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh core@192.168.10.1
</code></pre>
</div>

<p>Connect to <code class="highlighter-rouge">kubernetes_minion-01</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh core@192.168.10.2
</code></pre>
</div>

<h3 id="interacting-with-your-kubernetes-cluster-with-the-kube--scripts">Interacting with your Kubernetes cluster with the <code class="highlighter-rouge">kube-*</code> scripts.</h3>

<p>All of the following commands assume you have set <code class="highlighter-rouge">KUBERNETES_PROVIDER</code> appropriately:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KUBERNETES_PROVIDER</span><span class="o">=</span>libvirt-coreos
</code></pre>
</div>

<p>Bring up a libvirt-CoreOS cluster of 5 nodes</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nv">NUM_MINIONS</span><span class="o">=</span>5 cluster/kube-up.sh
</code></pre>
</div>

<p>Destroy the libvirt-CoreOS cluster</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cluster/kube-down.sh
</code></pre>
</div>

<p>Update the libvirt-CoreOS cluster with a new Kubernetes release produced by <code class="highlighter-rouge">make release</code> or <code class="highlighter-rouge">make release-skip-tests</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cluster/kube-push.sh
</code></pre>
</div>

<p>Update the libvirt-CoreOS cluster with the locally built Kubernetes binaries produced by <code class="highlighter-rouge">make</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nv">KUBE_PUSH</span><span class="o">=</span><span class="nb">local </span>cluster/kube-push.sh
</code></pre>
</div>

<p>Interact with the cluster</p>

<div class="highlighter-rouge"><pre class="highlight"><code>kubectl ...
</code></pre>
</div>

<h3 id="troubleshooting">Troubleshooting</h3>

<h4 id="cannot-find-kubernetes-server-linux-amd64targz">!!! Cannot find kubernetes-server-linux-amd64.tar.gz</h4>

<p>Build the release tarballs:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>make release
</code></pre>
</div>

<h4 id="cant-find-virsh-in-path-please-fix-and-retry">Can’t find virsh in PATH, please fix and retry.</h4>

<p>Install libvirt</p>

<p>On Arch:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>pacman -S qemu libvirt
</code></pre>
</div>

<p>On Ubuntu 14.04.1:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>aptitude install qemu-system-x86 libvirt-bin
</code></pre>
</div>

<p>On Fedora 21:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>yum install qemu libvirt
</code></pre>
</div>

<h4 id="error-failed-to-connect-socket-to-varrunlibvirtlibvirt-sock-no-such-file-or-directory">error: Failed to connect socket to ‘/var/run/libvirt/libvirt-sock’: No such file or directory</h4>

<p>Start the libvirt daemon</p>

<p>On Arch:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>systemctl start libvirtd
</code></pre>
</div>

<p>On Ubuntu 14.04.1:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>service libvirt-bin start
</code></pre>
</div>

<h4 id="error-failed-to-connect-socket-to-varrunlibvirtlibvirt-sock-permission-denied">error: Failed to connect socket to ‘/var/run/libvirt/libvirt-sock’: Permission denied</h4>

<p>Fix libvirt access permission (Remember to adapt <code class="highlighter-rouge">$USER</code>)</p>

<p>On Arch and Fedora 21:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat &gt; /etc/polkit-1/rules.d/50-org.libvirt.unix.manage.rules <span class="sh">&lt;&lt;EOF
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">polkit</span>.<span class="n">addRule</span>(<span class="n">function</span>(<span class="n">action</span>, <span class="n">subject</span>) {
        <span class="n">if</span> (<span class="n">action</span>.<span class="n">id</span> == <span class="s2">"org.libvirt.unix.manage"</span> &amp;&amp;
            <span class="n">subject</span>.<span class="n">user</span> == <span class="s2">"$USER"</span>) {
                <span class="n">return</span> <span class="n">polkit</span>.<span class="n">Result</span>.<span class="n">YES</span>;
                <span class="n">polkit</span>.<span class="n">log</span>(<span class="s2">"action="</span> + <span class="n">action</span>);
                <span class="n">polkit</span>.<span class="n">log</span>(<span class="s2">"subject="</span> + <span class="n">subject</span>);
        }
});
<span class="n">EOF</span>
</code></pre>
</div>

<p>On Ubuntu:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>usermod -a -G libvirtd <span class="nv">$USER</span>
</code></pre>
</div>

<h4 id="error-out-of-memory-initializing-network-virsh-net-create">error: Out of memory initializing network (virsh net-create…)</h4>

<p>Ensure libvirtd has been restarted since ebtables was installed.</p>

        <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/getting-started-guides/libvirt-coreos.md?pixel" alt="Analytics" /></a>
        <div id="pd_rating_holder_8345992"></div>
		<script type="text/javascript">
        PDRTJS_settings_8345992 = {
        "id" : "8345992",
        "unique_id" : "/docs/getting-started-guides/libvirt-coreos/",
        "title" : "libvirt on CoreOS",
        "permalink" : "http://kubernetes.github.io/docs/getting-started-guides/libvirt-coreos/"
        };
        (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
        </script>
	</div>
</section>

<footer>
	<main class="light-text">
		<nav>
			<a href="/docs/hellonode/">Get Started</a>
			<a href="/docs/">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/community/">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="enter your wish"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>



<style>
	.cse .gsc-control-cse, .gsc-control-cse {
		padding: 0;
	}

	.gsc-above-wrapper-area {
		border-bottom: 0;
	}
</style>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36037335-10', 'auto');
  ga('send', 'pageview');
</script>
<!-- Commenting out AnswerDash for now; we need to work on our list of questions/answers/design first
<!-- Start of AnswerDash script <script>var AnswerDash;!function(e,t,n,s,a){if(!t.getElementById(s)){var i,r=t.createElement(n),c=t.getElementsByTagName(n)[0];e[a]||(i=e[a]=function(){i.__oninit.push(arguments)},i.__oninit=[]),r.type="text/javascript",r.async=!0,r.src="https://p1.answerdash.com/answerdash.min.js?siteid=756",r.setAttribute("id",s),c.parentNode.insertBefore(r,c)}}(window,document,"script","answerdash-script","AnswerDash");</script> <!-- End of AnswerDash script -->
-->
</body>
</html>